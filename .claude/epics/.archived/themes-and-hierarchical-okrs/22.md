---
name: Update and add tests for recursive OKR nesting
status: closed
created: 2026-02-06T10:11:45Z
updated: 2026-02-06T10:17:09Z
github: https://github.com/rknuus/Bearing/issues/22
depends_on: [19]
parallel: true
conflicts_with: []
---

# Update and add tests for recursive OKR nesting

## Description

Update existing tests in `internal/access/plan_access_test.go` for recursive ID generation and in `internal/managers/planning_manager_test.go` for the new CRUD signatures. Add new tests covering: creating 3-level deep objectives, adding key results at intermediate levels, verifying that deleting a parent cascades its children, and ensuring existing flat data still loads correctly. Run the full test suite with `make test`.

## Acceptance Criteria

- [ ] All existing tests pass (updated for new signatures)
- [ ] New tests cover 3+ level nesting (create objective 3 levels deep)
- [ ] New test verifies adding key results at intermediate (non-leaf) levels
- [ ] New test verifies deleting a parent objective cascades removal of its children
- [ ] Test for backward compatibility with flat (non-nested) data
- [ ] `make test` passes clean with no failures

## Technical Details

- **Files**: `internal/access/plan_access_test.go`, `internal/managers/planning_manager_test.go`
- Update `plan_access_test.go`:
  - Adjust existing ID generation tests to account for recursive `ensureThemeIDs()` behavior
  - Add test cases that build a 3+ level objective tree and verify generated IDs follow `THEME-XX.OKR-XX.OKR-XX` pattern
  - Add test that loads a `themes.json` without the `objectives` field and confirms it deserializes to empty slices
- Update `planning_manager_test.go`:
  - Update existing CRUD tests for the new `CreateObjective(parentId, title)` signature (parentId can be theme or objective)
  - Update `UpdateObjective`, `DeleteObjective`, `CreateKeyResult`, `UpdateKeyResult`, `DeleteKeyResult` tests for tree-walk behavior
  - Add test: create objective under an objective (not a theme), verify it appears in the parent's `Objectives` slice
  - Add test: create 3-level hierarchy, then delete the middle objective — verify its children are also removed
  - Add test: create key result on an intermediate objective (one that has child objectives), verify it is stored correctly
- Run `make test` to confirm all tests pass

## Dependencies

- Depends on #19 (Recursive CRUD in PlanningManager) — the tests exercise the updated CRUD methods and ID generation
- Can be done in parallel with tasks #20-#21

## Effort Estimate

- **Size**: S
- **Hours**: 1.5

## Definition of Done

- All existing tests in `plan_access_test.go` and `planning_manager_test.go` are updated for the new recursive signatures and pass
- New tests cover: 3+ level nesting, KRs at intermediate levels, parent deletion cascading children, backward compatibility with flat data
- `make test` passes cleanly with no failures or skipped tests
- Test coverage for the recursive tree-walk and ID generation logic is comprehensive
