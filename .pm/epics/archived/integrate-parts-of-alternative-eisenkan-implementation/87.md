---
name: Create Rule Engine package and integrate into PlanningManager
status: open
created: 2026-02-08T14:54:43Z
updated: 2026-02-08T14:59:38Z
github: https://github.com/rknuus/Bearing/issues/87
depends_on: [001]
parallel: false
conflicts_with: []
---

# Task: Create Rule Engine package and integrate into PlanningManager

## Description

Create the `internal/engines/rule_engine/` package following iDesign layering (engines between managers and access). Implement rule evaluation for task transitions, WIP limits, task age, and required fields. Add subtask hierarchy enforcement (max depth 2, circular reference prevention, cascade policies). Add priority promotion processing. Wire the rule engine into PlanningManager's CreateTask, UpdateTask, and MoveTask flows. Store rules in a `rules.json` file with a permissive default ruleset.

## Acceptance Criteria

- [ ] `internal/engines/rule_engine/` package exists with `IRuleEngine` interface
- [ ] `EvaluateTaskChange(event, boardPath)` validates task operations and returns `RuleEvaluationResult { Allowed, Violations }`
- [ ] Rule types implemented: `max_wip_limit`, `allowed_transitions`, `max_age_days`, `required_fields`
- [ ] `RuleViolation` includes: RuleID, Priority, Message, Category (validation/workflow/automation)
- [ ] Context enrichment gathers WIP counts per column from access layer
- [ ] Default `rules.json` created on first use with permissive defaults (high WIP limits, all transitions allowed)
- [ ] Subtask hierarchy: `ParentTaskID` validated (exists, no circular refs, max depth 2)
- [ ] Subtask cascade: parent auto-moves to "doing" when first child starts; parent completion cascades children to "done"
- [ ] `ProcessPriorityPromotions()` promotes tasks with reached promotion dates (Q2→Q1)
- [ ] Promoted tasks have `PromotionDate` cleared after promotion
- [ ] PlanningManager calls rule engine before all task mutations (create, update, move)
- [ ] MoveTask returns validation result with rule violations on rejection
- [ ] `ProcessPriorityPromotions` exposed as Wails binding
- [ ] Rule engine validates moves in < 10ms for boards with up to 500 tasks
- [ ] Go unit tests for rule engine (all rule types, subtask validation, promotion logic)
- [ ] Go integration tests for full PlanningManager→RuleEngine→Access flows

## Technical Details

**New files:**
- `internal/engines/rule_engine/rule_engine.go` — `IRuleEngine` interface, `RuleEngine` struct, `EvaluateTaskChange()`, context enrichment
- `internal/engines/rule_engine/rule_engine_test.go` — unit tests for all rule types
- `internal/engines/rule_engine/models.go` — `TaskEvent`, `RuleViolation`, `RuleEvaluationResult`, `EnrichedContext`

**Files to modify:**
- `internal/managers/planning_manager.go` — inject `IRuleEngine`, call `EvaluateTaskChange` in CreateTask/UpdateTask/MoveTask; add `ProcessPriorityPromotions()`; add subtask cascade logic
- `internal/access/plan_access.go` — add `GetRulesData()` for context enrichment (WIP counts, hierarchy map)
- `main.go` — add `ProcessPriorityPromotions` binding

**Key considerations:**
- Rule engine is stateless — all context gathered per evaluation from access layer
- `sync.RWMutex` at PlanningManager level for thread safety (already exists)
- Promotion only escalates not-urgent-important → urgent-important (single promotion path)
- Subtask cascade orchestrated in PlanningManager, not rule engine (rule engine validates, manager orchestrates)

**Reference:** `tmp/eisenkan/internal/engines/rule_engine/` for interface and evaluation patterns

## Dependencies

- [ ] Task 001 — extended Task model and access layer

## Effort Estimate

- Size: XL
- Parallel: false — frontend tasks depend on backend rule validation responses
